function mtpt_init_editor(e){if(jQuery("#"+e).length){var t=function(e,t){var a;if(e.match("{{")){for(;null!=(a=e.next())&&("}"!=a||"}"!=e.next()););return e.eat("}"),"mustache"}if(e.match("%")){for(;null!=(a=e.next())&&"%"!=a;);return e.eat("%"),"command"}for(;null!=e.next()&&!e.match("{{",!1)&&!e.match("%",!1););return null},a={lineNumbers:!0,matchBrackets:!0,tabSize:2,indentUnit:2,indentWithTabs:!0,enterMode:"keep",tabMode:"shift",lineWrapping:!0,extraKeys:{"Ctrl-Space":"autocomplete"}};return CodeMirror.defineMode("mustache",function(a,i){var r={token:t};return CodeMirror.overlayMode(CodeMirror.getMode(a,i.backdrop||jQuery("#"+e).data("mode")),r)}),a.mode="mustache",mtpt_code_editor=CodeMirror.fromTextArea(document.getElementById(e),a),mtpt_code_editor.on("blur",function(e){e.save(),jQuery(e.getInputField()).trigger("change")}),mtpt_code_editor}}function find_if_in_wrapper(e,t,a){if(in_entry=!1,e.findPrevious()){console.log(e);var i=e.from();if(t.findPrevious()){var r=t.from();if(i.line>r.line)in_entry=i;else{if(i.line!==r.line)return console.log(i),e=a.getSearchCursor("{{#each ",i),find_if_in_wrapper(e,t,a);i.ch>r.ch&&(in_entry=i)}}else console.log(i),in_entry=i}if(in_entry){var n=a.getSearchCursor("}}",in_entry);if(n.findNext()){var r=n.from();start_tag=e.to(),in_entry=a.getRange(start_tag,r)}}return in_entry}function tagFields(e,t){if(8!==t.keyCode){var a=e.getCursor(),i=e.getSearchCursor("{{#each ",a),r=e.getSearchCursor("{{/each}}",a),n=e.getSearchCursor("{{#if ",a),o=e.getSearchCursor("{{/if",a),c=find_if_in_wrapper(i,r,e),s=!1;if(n.findPrevious()){var d=n.from();if(o.findPrevious()){var l=o.from();d.line>l.line?s=!0:d.line===l.line&&d.ch>l.ch&&(s=!0)}else s=!0}if(s){var u=e.getSearchCursor("}}",d);if(u.findNext()){var l=u.from();start_tag=i.to(),s=e.getRange(start_tag,l)}}if(!e.state.completionActive||18===t.keyCode){var m,g=e.getTokenAt(a),m=g.string.slice(0);if(m&&g.type){var f={};g.type&&(c?(s||(f={"/each":"/each"}),f["@key"]="@key",jQuery(".metaplate-autocomplete-in-entry-"+g.type).each(function(){var e=jQuery(this);(e.hasClass("parent-"+c)||e.hasClass("parant-all"))&&(f[e.data("slug")]=e.data("label"),e.data("label").indexOf("#")<0&&(f["#if "+e.data("slug")]="#if "+e.data("label")))})):jQuery(".metaplate-autocomplete-out-entry-"+g.type).each(function(){var e=jQuery(this);f[e.data("slug")]=e.data("label"),e.data("label").indexOf("#")<0&&(f["#if "+e.data("slug")]="#if "+e.data("label"))}),s&&(f["else"]="else",f["/if"]="/if"));var p=[],_=[],h={};for(var v in f)f.hasOwnProperty(v)&&(v.indexOf("#")<0&&v.indexOf("/")<0?p.push(v):_.push(v));p.sort(),_.sort(),p=p.concat(_),jQuery.each(p,function(e,t){h[t]=f[t]}),CodeMirror.showHint(e,CodeMirror.hint.elementfield,{fields:h,mode:g.type})}}}}var metaplate_canvas=!1,mtpt_get_config_object,mtpt_record_change,mtpt_canvas_init,mtpt_get_default_setting,mtpt_code_editor,init_magic_tags,mtpt_handle_save,mtpt_rebuild_magics,config_object={},magic_tags=[];jQuery(function(e){mtpt_handle_save=function(t){var a;a=e(t.data.success?".updated_notice_box":".error_notice_box"),a.stop().animate({top:-5},200,function(){setTimeout(function(){a.stop().animate({top:-75},200)},2e3)})},init_magic_tags=function(){var e=jQuery(".magic-tag-enabled");e.each(function(e,t){var a=jQuery(t);if(a.hasClass("magic-tag-init-bound")){var i=a.parent().find(".magic-tag-init");return void(a.is(":visible")?i.show():i.hide())}var r=jQuery('<span class="dashicons dashicons-editor-code magic-tag-init"></span>'),n=jQuery('<span style="position:relative;display:inline-block; width:100%;"></span>');a.is("input")&&r.css("borderBottom","none"),a.hasClass("metaplate-conditional-value-field")&&n.width("auto"),r.insertAfter(a),a.addClass("magic-tag-init-bound"),a.is(":visible")?r.show():r.hide()})},mtpt_get_config_object=function(t){e("#metaplate-id").trigger("change");for(var a=e(t),i=e("#metaplate-live-config").val(),r=e("[required]"),n=!0,o=0;o<r.length;o++)r[o].value.length<=0&&e(r[o]).is(":visible")?(e(r[o]).addClass("metaplate-input-error"),n=!1):e(r[o]).removeClass("metaplate-input-error");return n&&(metaplate_canvas=i),a.data("config",i),n},mtpt_record_change=function(){jQuery("#metaplate-id").trigger("change"),jQuery("#metaplate-field-sync").trigger("refresh")},mtpt_canvas_init=function(){metaplate_canvas||(jQuery("#metaplate-main-canvas").on("keydown keyup change","input, select, textarea",function(e){config_object=jQuery("#metaplate-main-form").formJSON(),jQuery("#metaplate-live-config").val(JSON.stringify(config_object)).trigger("change")}),mtpt_init_editor(),metaplate_canvas=jQuery("#metaplate-live-config").val(),config_object=JSON.parse(metaplate_canvas)),e(".color-field").wpColorPicker({change:function(t){e("#metaplate-id").trigger("change")}}),mtpt_rebuild_magics()},mtpt_get_default_setting=function(e){var t="node_"+Math.round(99887766*Math.random())+"_"+Math.round(99887766*Math.random()),a=e.trigger?e.trigger:e.params.trigger;a.data("group")?a.data("group"):"node_"+Math.round(99887766*Math.random())+"_"+Math.round(99887766*Math.random());switch(a.data("addNode")&&(config_object[a.data("addNode")]||(config_object[a.data("addNode")]={}),config_object[a.data("addNode")][t]={_id:t}),a.data("removeNode")&&config_object[a.data("removeNode")]&&delete config_object[a.data("removeNode")],a.data("script")){case"add-to-object":}jQuery("#metaplate-live-config").val(JSON.stringify(config_object)),jQuery("#metaplate-field-sync").trigger("refresh")},e.widget("custom.catcomplete",e.ui.autocomplete,{_create:function(){this._super(),this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(t,a){var i=this,r="";e.each(a,function(e,a){var n;a.category!=r&&(t.append("<li class='ui-autocomplete-category'>"+a.category+"</li>"),r=a.category),n=i._renderItemData(t,a),a.category&&n.attr("aria-label",a.category+" : "+a.label)})}}),mtpt_rebuild_magics=function(){function t(e){return e.split(/ \s*/)}function a(e){return t(e).pop()}e(".magic-tag-enabled").bind("keydown",function(t){t.keyCode===e.ui.keyCode.TAB&&e(this).catcomplete("instance").menu.active&&t.preventDefault()}).catcomplete({minLength:0,source:function(t,i){magic_tags=[];var r="";if(config_object.search_form&&config_object.form_fields){var n=["autocomplete_item"];for(r=e("#metaplate-label-tags").text(),f=0;f<n.length;f++)magic_tags.push({label:"{"+n[f]+"}",category:r})}i(e.ui.autocomplete.filter(magic_tags,a(t.term)))},focus:function(){return!1},select:function(e,a){var i=t(this.value);return i.pop(),i.push(a.item.value),this.value=i.join(" "),!1}})},e(document).on("click",".metaplate-card-actions .confirm a",function(t){t.preventDefault();var a=e(this).closest(".metaplate-card-content");actions=a.find(".row-actions"),actions.slideToggle(300)}),e(document).on("keyup change",'[data-format="slug"]',function(t){var a=e(this);return a.data("master")&&a.prop("required")&&this.value.length<=0&&"change"===t.type?(this.value=e(a.data("master")).val().replace(/[^a-z0-9]/gi,"_").toLowerCase(),void(this.value.length&&a.trigger("change"))):void(this.value=this.value.replace(/[^a-z0-9]/gi,"_").toLowerCase())}),e(document).on("keyup change","[data-sync]",function(){var t=e(this),a=e(t.data("sync"));a.is("input")?a.val(t.val()).trigger("change"):a.text(t.val())}),e(document).on("click",".metaplate-nav-tabs > li > a",function(t){t.preventDefault();for(var a=e(this),i=a.attr("href"),r=e("[required]"),n=!0,o=0;o<r.length;o++)r[o].value.length<=0&&e(r[o]).is(":visible")?(e(r[o]).addClass("metaplate-input-error"),n=!1):e(r[o]).removeClass("metaplate-input-error");n&&(e(".metaplate-nav-tab.active").removeClass("active"),a.parent().addClass("active"),e(".metaplate-editor-panel").hide(),e(i).show(),mtpt_code_editor&&(mtpt_code_editor.toTextArea(),mtpt_code_editor=!1),e(i).find(".metaplate-code-editor").length&&(mtpt_init_editor(e(i).find(".metaplate-code-editor").prop("id")),mtpt_code_editor.refresh(),mtpt_code_editor.focus()),jQuery("#metaplate-active-tab").val(i).trigger("change"))}),e(document).on("click","[data-remove-parent]",function(t){var a=e(this);a.closest(a.data("removeParent")).remove();mtpt_record_change()}),e("body").on("click",".magic-tag-init",function(t){var a=e(this),i=a.prev();i.focus().trigger("init.magic")}),e(document).on("change","[data-live-sync]",function(e){mtpt_record_change()}),e(".wp-baldrick").baldrick({request:ajaxurl,method:"POST"}),window.onbeforeunload=function(e){return metaplate_canvas&&metaplate_canvas!==jQuery("#metaplate-live-config").val()?!0:void 0}}),function(){"use strict";function e(e,a){var i=e.getCursor(),r=e.getTokenAt(i),n=[],o=a.fields;switch("sqlmustache"===e.getMode().name&&(a.mode="sqlmustache"),a.mode){case"mustache":var c={start:"{{",end:"}}"},s=r.string.slice(2);break;case"command":var c={start:"%",end:"%"},s=r.string.slice(1);break;default:var c={start:"",end:"}}"},s=r.string}for(var d in o)(0==d.indexOf(s)||"{"===s||0==o[d].indexOf(s))&&("{"===s&&(c.start="{"),n.push({text:c.start+d+c.end,displayText:o[d]}));return{list:n,from:t(i.line,r.start),to:t(i.line,r.end)}}if("undefined"!=typeof CodeMirror&&metaplate_canvas!==!1){var t=CodeMirror.Pos;CodeMirror.registerHelper("hint","elementfield",e)}}();